---
title: "Estimating COVID-19 Epidemic Growth Rates in Canada"
author: "Zachary Levine"
date: '2020-10-27'
output: 
  pdf_document:
      includes:
        in_header: 4mbapreamble.tex
      extra_dependencies: ["flafter"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
```

## Executive Summary
Here, we summarize some key features for the provinces below. 

## Key choices

### Provinces included
It is important to highlight several choices made during this analysis that could influence the reliability of our results. First and foremost, epidemic initial growth rates were only fit for the ten Canadian provinces, excluding the territories of Nunavut, the Yukon, and the Northwest Territories. We excluded Nunavut because the province only reported one case over the entire observation period. Likewise, given the low total case reports for Yukon and the Northwest Territories (23 and 10, respectively), we were unable to get useful fits to the epidemic growth rates there too. 

#### Corrections to the data
Data was given as cumulative case counts, for each day, for each province. We derived interval incidence by differencing that time series with a lag of one.

Next, on some days (eg. 2020-03-25) provinces (eg. Newfoundland and Labrador) reported new COVID-19 cases multiple times. This resulted in repeated observations with differing case reports for that day. To correct this, we added the two case counts together for those days, and removed the duplicated date entirely. Likewise we removed the report for New Brunswick on April 4th, 2020, as it seemed too far an outlier to be realistic.

While we speculated that negative cases, which were observed in multiple provinces, could have been reported to correct earlier totals, we had no guarantees to that end. This informed our decision to remove all days with negative case reports from the data.

In addition, irregular weekend reporting patterns were observed for the provinces of British Columbia and Alberta (22 and 11, respectively). We defined a case of faulty weekend reporting as weekend with zero cases reported on Saturday and Sunday, and nonzero case reports on the days before and after the weekend. For these two provinces, we removed all weekend dates from the time series, and added the reports for Saturday and Sunday to the following Monday if they were nonzero.

```{r echo=FALSE, message= FALSE, warning=FALSE, dev="tikz", results="hide"}
library(epigrowthfit)
library(tikzDevice)
library(Hmisc)
library(dplyr)
library(anytime)
library(chron)
##There should be no math in the executive summary. Explain clearly what you're talking about, but make sure the executive summary is accessible very broadly.
covid.canada.filename <- "COVID19_Canada.csv"
ignore <- c("NT", "NU", "YT")
allcases <- read.csv(covid.canada.filename)[,c("Province", "Date", "confirmed_positive", "Note")]
##Get rid of rows with duplicate dates, such as (NL-2020-03-25), by removing the duplicated date and adding its case reports to first report for that date.
##First grab the indices of the original dates one row above the repeated dates.
originalDateIndices <- (diff(anytime::anydate(allcases$Date)) == 0)[c(2:length(diff(anytime::anydate(allcases$Date)) == 0), FALSE)]
##Add the second case report to the first.
allcases[originalDateIndices, "confirmed_positive"] <- allcases[originalDateIndices, "confirmed_positive"] + allcases[diff(anytime::anydate(allcases$Date)) == 0, "confirmed_positive"]
##Get rid of the duplicate dates.
allcases <- allcases[!diff(anytime::anydate(allcases$Date)) == 0,]
wave1beginings <- c("ON" = 11, "AB" = 2, "QC" = 5, "BC" = 1, "SK" = 5, "MB" = 1, "NL" = 1, "NB" = 3, "NS" = 1, "PEI" = 6, "YT" = 20, "NT" = 1, "NU" = NA)
wave1endings <- c("ON" = 77 , "AB" = 38, "QC" = 29, "BC" = 9, "SK" = 16, "MB" = 16, "NL" = 7, "NB" = 23, "NS" = 34, "PEI" = 15, "YT" = 29, "NT" = 23, "NU" = NA)
wave2beginings <- list("ON" = 188, "AB" = 133, "QC" = 185, "BC" = 151, "SK" = 194, "MB" = 195, "NL" = 221, "NB" = 198, "NS" = 213, "PEI" = 200, "YT" = 201, "NT" = 200, "NU" = NA)
##Pass "end" to the pipeline to specify that we should end the second wave at the last possible observation date.
wave2endings <- c("ON" = "end", "AB" = 173, "QC" = 212, "BC" = "end" , "SK" = "end", "MB" = "end", "NL" = 229, "NB" = 210, "NS" = "end", "PEI" = 170, "YT" = 216 , "NT" = 214, "NU" = NA)
splitintervalCases <- lapply(as.vector(unique(allcases$Province)), function(provinceName){
  ##For each province, select all the data corresponding to that province.
  casesdf <- allcases[as.vector(allcases$Province) == provinceName,]
  ##Get rid of missing values.
  casesdf <- casesdf[!is.na(casesdf$"confirmed_positive"),]
  ##Get rid of the anomaly report in NB.
  if (provinceName == "NB"){
    casesdf <- casesdf[casesdf$Date != "2020-04-02",]
  }
  else{
  }
  ##Derive interval incidence by differencing (discarding the first reported entry to align all the columns and keep them the same length), keeping the column for each provience as a check to make sure we're doing everthing properly.
intervalcasesdf <- bind_cols("Date" = casesdf$"Date",
                           "Province" =  casesdf$"Province",
                           "Note" = casesdf$"Note",
                           "intervalCases" = c(0, diff(casesdf$"confirmed_positive", lag = 1)))
  ##Some row of contain a negative value, so let's get rid of them
  intervalcasesdf <- intervalcasesdf[intervalcasesdf$intervalCases >= 0,]
  ##Make a list of sums of weekend case reports such that the ith element is the sum of the reported cases on Saturday and Sunday for the ith weekend.
  if (provinceName == "BC" || provinceName  == "AB"){
  weekendSums <- as.list(intervalcasesdf[ format(as.Date(anytime::anydate(intervalcasesdf$Date)), '%A') == "Saturday","intervalCases"])$intervalCases +
  as.list(intervalcasesdf[format(as.Date(anytime::anydate(intervalcasesdf$Date)), '%A') == "Sunday","intervalCases"])$intervalCases
  mondayIndices <- format(as.Date(anytime::anydate(intervalcasesdf$Date)), '%A') == "Monday"
  ##If the weekend reports were zero and the monday report was not, assume improper reporting and make the Monday cases the sum of the Monday cases the case reports on the weekends.
  intervalcasesdf[mondayIndices,"intervalCases"] <- c(0, weekendSums[1:length(weekendSums)-1]) + intervalcasesdf[mondayIndices,"intervalCases"]
  ##Remove the weekends.
  intervalcasesdf <- intervalcasesdf[!is.weekend(anytime::anydate(intervalcasesdf$Date)),]
  }
  else{
  }
  return(intervalcasesdf)
  })
names(splitintervalCases) <- as.vector(unique(allcases$Province))
##Make a list of instantiated egf objects for each wave and each province.
##We have to difference the cumulative cases to get interval cases, but in doing so we get rid of the first case report. Set it to zero to make the data frame with all columns of the same length, but get rid of it before initializing egf objects.
##Each element of egfs is a list for the corresponding province containing the egf_init object for the first wave and the second wave separately.
egfs <- sapply(names(splitintervalCases)[!names(splitintervalCases) %in% ignore], function(provinceName){
  beginingwave1 <- as.numeric(wave1beginings[provinceName])
  beginingwave2 <- as.numeric(wave2beginings[provinceName])
  endingwave1 <- as.numeric(wave1endings[provinceName])
  endingwave2 <- wave2endings[provinceName]
    provincetimeseries <- data.frame(splitintervalCases[names(splitintervalCases) == provinceName])[4][,1][1:length(data.frame(splitintervalCases[names(splitintervalCases) == provinceName])[4][,1])]
  dates <- anytime::anydate(data.frame(splitintervalCases[names(splitintervalCases) == provinceName])[1][,1])
    if (endingwave2 == "end"){
    endingwave2 <- length(provincetimeseries)
  }
  else{
    endingwave2 <- as.numeric(endingwave2)
  }
  ##We get better fits for some provinces with this stuff.
  if (provinceName %in% c("QC", "BC", "NL")){
    ##Overriding the default first wave.
    if (provinceName =="NL"){
      theFirst <- egf_init(cases = provincetimeseries, date = dates, first = 1, last = 9)
    }
    else{
    theFirst <- egf_init(date = dates, cases = provincetimeseries, first = beginingwave1, last = endingwave1)
    }
    ##Overriding the default for the second wave.
    if (provinceName == "QC"){
    theSecond <- (egf_init(cases = provincetimeseries, date = dates, first = 165, peak = 212))
    }
    else if (provinceName == "NL"){
      theSecond <- egf_init(date = dates, cases = provincetimeseries, peak = 231, distr = "pois")
    }
    else{
        theSecond <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave2)
    }
  }
  ##These seem to work best with this setting.
  else if (provinceName  == "NS"){
  theFirst <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave1, distr = "pois")
  theSecond <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave2, peak = endingwave2, distr = "pois")
  }
  else if (provinceName == "NB"){
    theFirst <- egf_init(cases = provincetimeseries, date = dates, first = 3, last = 20, distr = "pois")
      theSecond <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave2, peak = endingwave2, distr = "pois")
  }
  else if (provinceName == "PEI"){
  theFirst <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave1, last = endingwave1, distr = "pois")
  theSecond <- egf_init(date = dates, cases = provincetimeseries, peak = 174, distr = "pois")
  }
    ##Really just ON and AB
  else{
  theFirst <- egf_init(date = dates, cases = provincetimeseries, first = beginingwave1, last = endingwave1)
  theSecond <- egf_init(date = dates, cases = provincetimeseries, first = beginingwave2)
  }
  ##We should make the epigrowthfit objects at the same time.
  return(list("first" = egf(theFirst),
              "second" = egf(theSecond)
)
         )
  })
names(egfs) <- names(splitintervalCases)[!names(splitintervalCases) %in% ignore]
egfs <- data.frame(egfs)
##Make it so we have each province as a row with columns first, seconds for the two waves.
egfs <- t(egfs)
```

## Results

We illustrate the parameter estimates of interest below.

```{r, echo = FALSE, warning=FALSE, results = "asis"}
##Make the table.
make_table <- function(egf_df, wave = "first"){
  data("covid_generation_interval")
  growthRates <- c()
  R0s <- c()
  doublingTimes <- c()
  i <- 1
  provincesList <- unique(allcases$Province)[!unique(allcases$Province) %in% ignore]
  while (i <= nrow(egf_df)){
    egfobj <- egf_df[[i, wave]]
    growthRates <- c(growthRates, egfobj$theta_fit[1])
    R0s <- c(R0s, compute_R0(egfobj, breaks = covid_generation_interval$breaks, probs = covid_generation_interval$probs))
    doublingTimes <- c(doublingTimes, compute_doubling_time(egfobj))
    i <- i + 1
  }
  return(data.frame("Province" = unique(allcases$Province)[!unique(allcases$Province) %in% ignore],
                         "Exponential Growth Rate" = growthRates,
                         "Doubling Time"= doublingTimes ,
                         "Reproduction Number" = R0s))
}
options(omitlatexcom = TRUE)
Hmisc::latex(make_table(egfs, wave = "first"), title = "", rowname = "", file = "")
Hmisc::latex(make_table(egfs, wave = "second"), title = "", rowname = "", file = "")
```

Make sure to answer
- Why are some fits better than others?
- How do the results differ among provinces?
- Why do you think they differ?
- Are there policy implications of your results that PHAC should consider?
- What are the most important take-home messages for PHAC?

#### Negative binomial models: Ontario, Quebec, Alberta, Saskatchewan, British Columbia, and Manitoba

All six provinces were fit with a logistic model of expected cumulative incidence, and a negative binomial model for observed interval incidence. The negative binomial model fit well because the dispersion parameter k was small for both waves (10.217 for Ontario wave 1, for instance). This, switching to a Poission model was not necessary.

One would expect though for any reasonable model would have fit well to these data though. This is primarly because large numbers of cases were reported on regular intervals, with no faulty weekend case reports for Ontario and Quebec.

In Alberta and British Columbia, though weekend reporting was faulty, the corrected sums fit the trend of the reports around them, resulting in a good model fit. In addition, Saskatchewan actually saw multiple mini epidemic waves before a big wave starting late October, not just two waves. We chose the biggest two to be the ones to study, but this may not have been the best choice. At least three mini waves occur before what we denote as the first wave, and it may have been better to fit to them. 

Selecting the best fitting window for British Columbia was difficult because there were three distinct waves of epidemic there. One epidemic ran dfrom March to April, one from June to September, and one from October to November. I chose the first and final wave to fit models to. British Columbia interval incidence grows subexponentially for a significant chunk of the time series. Thus, the initial epidemic growth rate isn't strongly representative of the initial phase of the second wave, because cases counts grew very slowly for a long time, and then shot up. However, after selecting the appropraiate fitting window, the negative binomial model fit well because the dispersion parameter k was small for both waves (W1 = 3.9931, W2 = 1.822).

In the first wave, BC had smallest R0. The largest difference between BC and Ontario was that BC had a stronger public health intervention strategy to manage the pandemic. BC's success in managing the first wave of the epidemic the importance of control strategies in managaing the epidemic. However, the fact that cases picked up after the first wave also shows the importance of sicking consistently to those interventions.

```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot <- function(egf_df, province){
  par(mfrow = c(2, 1))
  plot(egf_df[[province, "first"]])
  plot(egf_df[[province, "second"]], add = TRUE)
}
province_plot(egfs, "ON")
province_plot(egfs, "QC")
province_plot(egfs, "AB")
province_plot(egfs, "SK")
province_plot(egfs, "BC")
province_plot(egfs, "MB")
```

#### Poisson Models: Newfoundland and Labrador, Nova Scotia, New Brunsiwck, and Prince Edward Island

NL negbin wave 1, poisson wave 2. NS pois wave 1 and wave 2. NB pois wave 1 and wave 2. pei pois wave 1 and wave 2

There was only one real epidemic wave in Newfoundland and Labrador. However, the dispersion parameter k for the fitted model was 0.674, much below the threshold value as defined in the vignette, which explains why the negative binomial model fit well. We fit the second wave to a mostly flat second epidemic wave consiting of less than 5 cases at peak, which explains the poor fit of the model, as demonstrated in the corresponding plot below. It is unclear if growth rate has any practical interpretation, given the poor model fit that produced it. 

For the rest of the provinces and waves, the dispersion parameter for a fitted negative binomial model exceeded the threshold value as defined in the vignette. Therefore, Poision models fit better to the data.

New Brunswick has a very small wave in between the two epidemic waves we fit. We didn't fit to it because to the other two were much larger in magnitude. Also, the second wave in Nova Scotia is tiny, which could impact our model fit.  Prince Edward actually had four epidemic waves, the final three being very similar in size. Our estimates of epidemic growth rates are valid and useful insofar as we consider the waves we picked to the ones of interest.

```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "NL")
province_plot(egfs, "NB")
province_plot(egfs, "NS")
province_plot(egfs, "PEI")
```