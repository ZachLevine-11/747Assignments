---
title: "Estimating COVID-19 Epidemic Growth Rates in Canada"
author: "Zachary Levine"
date: '2020-10-27'
output: 
  pdf_document:
      includes:
        in_header: 4mbapreamble.tex
      extra_dependencies: ["flafter"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
```

## Executive Summary
Here, we summarize some key features for the provinces below. 

## Introduction
It is important to highlight several choices made during this analysis that could influence the reliability of our results. First and foremost, epidemic initial growth rates were only fit for the ten Canadian provinces. This meant that we excluded the territories of Nunavut, the Yukon, and the Northwest Territories from our analysis. We excluded Nunavut because its time series only had one nonzero case report for the entire time period. Likewise, given the low total case reports for Yukon and the Northwest Territories (23 and 10, respectively), we were unable to get proper fits to the epidemic growth rates.

In addition, some days (such as 2020-03-25) provinces like Newfoundland and Labrador reported cases multiple times. This resulted in repeated observations with differing case reports for that day. To correct this, we added the two case counts together for those days, and removed the duplicated date from the time series for that province. Likewise we removed the report for New Brunswick on "2020-04-02", as it seemed to result from faulty case reporting on that day and appeared to be an outlier - sitting far away from the rest of the reports of the epidemic. Also, some cases reports were negative. While we speculated that these could be employed to correct the case count, we did not know their true function, and so all days with negative case reports were removed from all provinces. 

Data was given as cumulative case counts, for each day, for each province. We derived interval incidence by differencing that time series with a lag of one. In addition, irregular weekend reporting patterns were observed for British Columbia and Alberta. We defined a situation with faulty weekend reporting as weekend with zero cases reported on Saturday and Sunday, and nonzero case reports on the Friday before and Monday after. BC had 21 of these weekends alone. For these two provinces then, we removed all weekend dates from the time series, and added the reports for Saturday and Sunday to the following Monday if they were nonzero.

```{r echo=FALSE, message= FALSE, warning=FALSE, dev="tikz", results="hide"}
library(epigrowthfit)
library(tikzDevice)
library(Hmisc)
library(dplyr)
library(anytime)
library(chron)
##There should be no math in the executive summary. Explain clearly what you're talking about, but make sure the executive summary is accessible very broadly.
covid.canada.filename <- "COVID19_Canada.csv"
ignore <- c("NT", "NU", "YT")
allcases <- read.csv(covid.canada.filename)[,c("Province", "Date", "confirmed_positive", "Note")]
##Get rid of rows with duplicate dates, such as (NL-2020-03-25), by removing the duplicated date and adding its case reports to first report for that date.
##First grab the indices of the original dates one row above the repeated dates.
originalDateIndices <- (diff(anytime::anydate(allcases$Date)) == 0)[c(2:length(diff(anytime::anydate(allcases$Date)) == 0), FALSE)]
##Add the second case report to the first.
allcases[originalDateIndices, "confirmed_positive"] <- allcases[originalDateIndices, "confirmed_positive"] + allcases[diff(anytime::anydate(allcases$Date)) == 0, "confirmed_positive"]
##Get rid of the duplicate dates.
allcases <- allcases[!diff(anytime::anydate(allcases$Date)) == 0,]
wave1beginings <- c("ON" = 11, "AB" = 2, "QC" = 5, "BC" = 1, "SK" = 5, "MB" = 1, "NL" = 1, "NB" = 3, "NS" = 1, "PEI" = 6, "YT" = 20, "NT" = 1, "NU" = NA)
wave1endings <- c("ON" = 77 , "AB" = 38, "QC" = 29, "BC" = 9, "SK" = 16, "MB" = 16, "NL" = 7, "NB" = 23, "NS" = 34, "PEI" = 15, "YT" = 29, "NT" = 23, "NU" = NA)
wave2beginings <- list("ON" = 188, "AB" = 133, "QC" = 185, "BC" = 151, "SK" = 194, "MB" = 195, "NL" = 221, "NB" = 198, "NS" = 213, "PEI" = 200, "YT" = 201, "NT" = 200, "NU" = NA)
##Pass "end" to the pipeline to specify that we should end the second wave at the last possible observation date.
wave2endings <- c("ON" = "end", "AB" = 173, "QC" = 212, "BC" = "end" , "SK" = "end", "MB" = "end", "NL" = 229, "NB" = 210, "NS" = "end", "PEI" = 170, "YT" = 216 , "NT" = 214, "NU" = NA)
splitintervalCases <- lapply(as.vector(unique(allcases$Province)), function(provinceName){
  ##For each province, select all the data corresponding to that province.
  casesdf <- allcases[as.vector(allcases$Province) == provinceName,]
  ##Get rid of missing values.
  casesdf <- casesdf[!is.na(casesdf$"confirmed_positive"),]
  ##Get rid of the anomaly report in NB.
  if (provinceName == "NB"){
    casesdf <- casesdf[casesdf$Date != "2020-04-02",]
  }
  else{
  }
  ##Derive interval incidence by differencing (discarding the first reported entry to align all the columns and keep them the same length), keeping the column for each provience as a check to make sure we're doing everthing properly.
intervalcasesdf <- bind_cols("Date" = casesdf$"Date",
                           "Province" =  casesdf$"Province",
                           "Note" = casesdf$"Note",
                           "intervalCases" = c(0, diff(casesdf$"confirmed_positive", lag = 1)))
  ##Some row of contain a negative value, so let's get rid of them
  intervalcasesdf <- intervalcasesdf[intervalcasesdf$intervalCases >= 0,]
  ##Make a list of sums of weekend case reports such that the ith element is the sum of the reported cases on Saturday and Sunday for the ith weekend.
  if (provinceName == "BC" || provinceName  == "AB"){
  weekendSums <- as.list(intervalcasesdf[ format(as.Date(anytime::anydate(intervalcasesdf$Date)), '%A') == "Saturday","intervalCases"])$intervalCases +
  as.list(intervalcasesdf[format(as.Date(anytime::anydate(intervalcasesdf$Date)), '%A') == "Sunday","intervalCases"])$intervalCases
  mondayIndices <- format(as.Date(anytime::anydate(intervalcasesdf$Date)), '%A') == "Monday"
  ##If the weekend reports were zero and the monday report was not, assume improper reporting and make the Monday cases the sum of the Monday cases the case reports on the weekends.
  intervalcasesdf[mondayIndices,"intervalCases"] <- c(0, weekendSums[1:length(weekendSums)-1]) + intervalcasesdf[mondayIndices,"intervalCases"]
  ##Remove the weekends.
  intervalcasesdf <- intervalcasesdf[!is.weekend(anytime::anydate(intervalcasesdf$Date)),]
  }
  else{
  }
  return(intervalcasesdf)
  })
names(splitintervalCases) <- as.vector(unique(allcases$Province))
##Make a list of instantiated egf objects for each wave and each province.
##We have to difference the cumulative cases to get interval cases, but in doing so we get rid of the first case report. Set it to zero to make the data frame with all columns of the same length, but get rid of it before initializing egf objects.
##Each element of egfs is a list for the corresponding province containing the egf_init object for the first wave and the second wave separately.
egfs <- sapply(names(splitintervalCases)[!names(splitintervalCases) %in% ignore], function(provinceName){
  beginingwave1 <- as.numeric(wave1beginings[provinceName])
  beginingwave2 <- as.numeric(wave2beginings[provinceName])
  endingwave1 <- as.numeric(wave1endings[provinceName])
  endingwave2 <- wave2endings[provinceName]
    provincetimeseries <- data.frame(splitintervalCases[names(splitintervalCases) == provinceName])[4][,1][1:length(data.frame(splitintervalCases[names(splitintervalCases) == provinceName])[4][,1])]
  dates <- anytime::anydate(data.frame(splitintervalCases[names(splitintervalCases) == provinceName])[1][,1])
    if (endingwave2 == "end"){
    endingwave2 <- length(provincetimeseries)
  }
  else{
    endingwave2 <- as.numeric(endingwave2)
  }
  ##We get better fits for some provinces with this stuff.
  if (provinceName %in% c("QC", "BC", "NL")){
    ##Overriding the default first wave.
    if (provinceName =="NL"){
      theFirst <- egf_init(cases = provincetimeseries, date = dates, first = 1, last = 9)
    }
    else{
    theFirst <- egf_init(date = dates, cases = provincetimeseries, first = beginingwave1, last = endingwave1)
    }
    ##Overriding the default for the second wave.
    if (provinceName == "QC"){
    theSecond <- (egf_init(cases = provincetimeseries, date = dates, first = 165, peak = 212))
    }
    else if (provinceName == "NL"){
      theSecond <- egf_init(date = dates, cases = provincetimeseries, peak = 231, distr = "pois")
    }
    else{
        theSecond <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave2)
    }
  }
  ##These seem to work best with this setting.
  else if (provinceName  == "NS"){
  theFirst <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave1, distr = "pois")
  theSecond <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave2, peak = endingwave2, distr = "pois")
  }
  else if (provinceName == "NB"){
    theFirst <- egf_init(cases = provincetimeseries, date = dates, first = 3, last = 20, distr = "pois")
      theSecond <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave2, peak = endingwave2, distr = "pois")
  }
  else if (provinceName == "NT"){
    theFirst <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave1, last = endingwave1, distr = "pois")
    theSecond <- egf_init(cases = provincetimeseries, date = dates, peak = 214, distr = "pois")
  }
  else if (provinceName == "PEI"){
  theFirst <- egf_init(cases = provincetimeseries, date = dates, first = beginingwave1, last = endingwave1, distr = "pois")
  theSecond <- egf_init(date = dates, cases = provincetimeseries, peak = 174, distr = "pois")
  }
  else if (provinceName == "YT"){
    theFirst <- egf_init(date = dates, cases = provincetimeseries, peak = 31, distr = "pois")
    theSecond <- egf_init(date = dates, cases = provincetimeseries, peak = 214, distr = "pois")
  }
    ##Really just ON and AB
  else{
  theFirst <- egf_init(date = dates, cases = provincetimeseries, first = beginingwave1, last = endingwave1)
  theSecond <- egf_init(date = dates, cases = provincetimeseries, first = beginingwave2)
  }
  ##We should make the epigrowthfit objects at the same time.
  return(list("first" = egf(theFirst),
              "second" = egf(theSecond)
)
         )
  })
names(egfs) <- names(splitintervalCases)[!names(splitintervalCases) %in% ignore]
egfs <- data.frame(egfs)
##Make it so we have each province as a row with columns first, seconds for the two waves.
egfs <- t(egfs)
```

```{r, echo = FALSE, warning=FALSE, results = "asis"}
##Make the table.
province_plot <- function(egf_df, province){
  par(mfrow = c(2, 1))
  plot(egf_df[[province, "first"]])
  plot(egf_df[[province, "second"]], add = TRUE)
}
make_table <- function(egf_df, wave = "first"){
  data("covid_generation_interval")
  growthRates <- c()
  R0s <- c()
  doublingTimes <- c()
  i <- 1
  provincesList <- unique(allcases$Province)[!unique(allcases$Province) %in% ignore]
  while (i <= nrow(egf_df)){
    egfobj <- egf_df[[i, wave]]
    growthRates <- c(growthRates, egfobj$theta_fit[1])
    R0s <- c(R0s, compute_R0(egfobj, breaks = covid_generation_interval$breaks, probs = covid_generation_interval$probs))
    doublingTimes <- c(doublingTimes, compute_doubling_time(egfobj))
    i <- i + 1
  }
  return(data.frame("Province" = unique(allcases$Province)[!unique(allcases$Province) %in% ignore],
                         "Exponential Growth Rate" = growthRates,
                         "Doubling Time"= doublingTimes ,
                         "Reproduction Number" = R0s))
}
options(omitlatexcom = TRUE)
Hmisc::latex(make_table(egfs, wave = "first"), title = "", rowname = "", file = "")
Hmisc::latex(make_table(egfs, wave = "second"), title = "", rowname = "", file = "")
```

## Model fit

Ontario fit very well, because large numbers of cases were reported on regular intervals, with no faulty weekend case reports. Quebec fit for both waves wasn't be because for both waves there is a period of exponential growth but the peak of the wave isn't reached, then we stop growing exponentially and then start again briefly before the peak. I chose the fitting window when growth becomes sub exponetial to obtain better fits, but this affects the validity of our results. Fitting to British Columbia was difficult because there were three distinct waves of epidemic there. One epidemic ran dfrom March to April, one from June to September, and one from October to November. I chose the first and final wave to fit models to. British Columbia interval incidence grows subexponentially for a significant chunk of the time series. Thus, the initial epidemic growth rate isn't strongly representative of the initial phase of the second wave, because cases counts grew very slowly for a long time, and then shot up. Manitoba data displays the same trend but on a smaller scale. Saskatchewan has multiple mini waves before a big one starting late October, not just two waves. We chose the biggest two to be the ones to study, but this may not have been the best choice. At least three mini waves occur before what we denote as the first wave, and it may have been better to fit to them. There was only one real epidemic wave in Newfoundland and Labrador Fit the second wave to a mostly flat second epidemic wave consiting of less than 5 cases at peak, which explains the poor fit of the model, as demonstrated in the corresponding plot below. It is unclear if growth rate has any practical interpretation, given the poor model fit that produced it. New Brunswick has a very small wave in between the two epidemic waves we fit. We didn't fit to it because to the other two were much larger in magnitude. Also, the second wave in Nova Scotia is tiny, which could impact our model fit. Prince Edward actually had four epidemic waves, the final three being very similar in size. Our estimates of epidemic growth rates are valid and useful insofar as we consider the waves we picked to the ones of interest.

## Interpreting differences in results

How do the results differ between provinces, and why doyou think they differ?

Epidemics tended to grow the fastest in provinces with larger cities and bigger populations. We see this when looking at

In the first wave, BC had smallest R0. The largest difference between BC and Ontario was that BC had a stronger public health intervention strategy to manage the pandemic. BC's success in managing the first wave of the epidemic the importance of control strategies in managaing the epidemic. However, the fact that cases picked up after the first wave also shows the importance of sicking consistently to those interventions.

## Plots

#### Ontario
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "ON")
```

#### Alberta
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "AB")
```

#### Quebec
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "QC")
```

#### British Columbia
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "BC")
```

#### Saskatchewan
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "SK")
```

#### Manitoba
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "MB")
```

#### Newfoundland and Labrador
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "NL")
```

#### New Brunswick
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "NB")
```

#### Nova Scotia
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "NS")
```

#### Prince Edward Island
```{r, echo = FALSE, fig.height = 8, fig.width = 8, warning=FALSE, results = "asis"}
province_plot(egfs, "PEI")
```